{"version":3,"sources":["oc/web/components/secure_activity.cljs"],"mappings":"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","names":["oc.web.components.secure-activity/win-width","or__4126__auto__","js/document","js/window","oc.web.components.secure-activity/maybe-load-comments","s","cljs.core/deref","activity-data","org.martinklepsch.derivatives/get-ref","comments-data","oc.web.utils.activity.get_comments_if_needed","rum.core/build-defcs","map__46946","cljs.core/PROTOCOL_SENTINEL","cljs.core.apply","cljs.core/hash-map","cljs.core.get","attrs46940","js/React.createElement","cljs.core/map?","sablono.interpreter/attributes","sablono.normalize.merge_with_class","sablono.interpreter/interpret","attrs46941","attrs46943","oc.web.components.secure-activity/secure-activity","rum.core/reactive","org.martinklepsch.derivatives.drv","oc.web.mixins.mention/oc-mentions-hover","oc.web.mixins.ui/refresh-tooltips-mixin","oc.web.lib.utils/after","oc.web.actions.activity/send-secure-item-seen-read","is-showing-alert","org.martinklepsch.derivatives/react","activity-author","is-mobile?","oc.web.lib.responsive/is-tablet-or-mobile?","id-token","org-data","cljs.core/select-keys","clojure.set/rename-keys","comments-drv","oc.web.utils.activity/activity-comments","activity-link","oc.web.lib.utils.link_for","oc.web.components.ui.login-overlay/login-overlays-handler","oc.web.components.ui.alert-modal/alert-modal","G__46949","G__46950","G__46951","G__46966","G__46967","G__46968","oc.web.components.ui.org-avatar/org-avatar","oc.web.actions.user/show-login","oc.web.components.ui.user-avatar/user-avatar-image","oc.web.router/redirect!","oc.web.urls/home","oc.web.lib.utils/emojify","oc.web.lib.utils/hide-class","G__46953","G__46973","oc.web.lib.utils/activity-date-tooltip","oc.web.lib.utils.date_string","oc.web.lib.utils.js_date","cljs.core/seq","G__46955","G__46974","oc.web.components.ui.poll/polls-wrapper","G__46956","G__46975","oc.web.components.ui.stream-attachments/stream-attachments","G__46957","G__46976","oc.web.components.ui.comments-summary/comments-summary","G__46958","G__46977","oc.web.components.reactions/reactions","cljs.core/count","rum.core/with-key","G__46959","G__46978","oc.web.components.ui.add-comment/add-comment","G__46962","G__46979","oc.web.components.stream-comments/stream-comments","G__46965","G__46982","oc.web.components.ui.loading/loading"],"sourcesContent":["(ns oc.web.components.secure-activity\n  (:require [rum.core :as rum]\n            [org.martinklepsch.derivatives :as drv]\n            [oc.web.urls :as oc-urls]\n            [oc.web.lib.utils :as utils]\n            [oc.web.router :as router]\n            [oc.web.utils.activity :as au]\n            [oc.web.local-settings :as ls]\n            [oc.web.mixins.ui :as ui-mixins]\n            [oc.web.lib.responsive :as responsive]\n            [oc.web.actions.user :as user-actions]\n            [oc.web.mixins.mention :as mention-mixins]\n            [oc.web.actions.activity :as activity-actions]\n            [oc.web.components.ui.loading :refer (loading)]\n            [oc.web.components.reactions :refer (reactions)]\n            [oc.web.components.ui.poll :refer (polls-wrapper)]\n            [oc.web.components.ui.org-avatar :refer (org-avatar)]\n            [oc.web.components.ui.add-comment :refer (add-comment)]\n            [oc.web.components.ui.alert-modal :refer (alert-modal)]\n            [oc.web.components.stream-comments :refer (stream-comments)]\n            [oc.web.components.ui.user-avatar :refer (user-avatar-image)]\n            [oc.web.components.ui.comments-summary :refer (comments-summary)]\n            [oc.web.components.ui.login-overlay :refer (login-overlays-handler)]\n            [oc.web.components.ui.stream-attachments :refer (stream-attachments)]\n            [goog.events :as events]\n            [goog.events.EventType :as EventType]))\n\n(defn win-width []\n  (or (.-clientWidth (.-documentElement js/document))\n      (.-innerWidth js/window)))\n\n(defn- maybe-load-comments [s]\n  (let [activity-data (:activity-data @(drv/get-ref s :secure-activity-data))\n        comments-data @(drv/get-ref s :comments-data)]\n    (au/get-comments-if-needed activity-data comments-data)))\n\n(rum/defcs secure-activity < rum/reactive\n                             ;; Derivatives\n                             (drv/drv :secure-activity-data)\n                             (drv/drv :id-token)\n                             (drv/drv :comments-data)\n                             ;; Mixins\n                             (mention-mixins/oc-mentions-hover)\n                             ui-mixins/refresh-tooltips-mixin\n                             {:did-mount (fn [s]\n                               (maybe-load-comments s)\n                               s)\n                              :will-update (fn [s]\n                               (maybe-load-comments s)\n                               s)\n                              :after-render (fn [s]\n                               ;; Delay to make sure the change socket was initialized\n                               (utils/after 2000 #(activity-actions/send-secure-item-seen-read))\n                               s)}\n  [s]\n  (let [{:keys [activity-data is-showing-alert]} (drv/react s :secure-activity-data)\n        activity-author (:publisher activity-data)\n        is-mobile? (responsive/is-tablet-or-mobile?)\n        id-token (drv/react s :id-token)\n        org-data (-> activity-data\n                  (select-keys [:org-slug :org-name :org-logo-url])\n                  (clojure.set/rename-keys {:org-slug :slug\n                                            :org-name :name\n                                            :org-logo-url :logo-url}))\n        comments-drv (drv/react s :comments-data)\n        comments-data (au/activity-comments activity-data comments-drv)\n        activity-link (utils/link-for (:links org-data) \"entries\")]\n    [:div.secure-activity-container\n      (login-overlays-handler)\n      (when is-showing-alert\n        (alert-modal))\n      (when activity-data\n        [:div.activity-header.group\n          (org-avatar org-data activity-link (if is-mobile? :never :always))\n          (if id-token\n            [:div.activity-header-right\n              [:button.mlb-reset.login-as-bt\n                {:on-click #(user-actions/show-login :login-with-email)\n                 :data-toggle (when-not is-mobile? \"tooltip\")\n                 :data-placement \"bottom\"\n                 :data-container \"body\"\n                 :title \"Log in to view all posts\"}\n                [:span.login-as\n                  \"Log in as \" (:first-name id-token)]\n                (user-avatar-image id-token)]]\n            [:div.activity-header-right\n              [:button.mlb-reset.learn-more-bt\n                {:on-click #(router/redirect! oc-urls/home)}\n                (str \"learn more\"\n                 (when-not is-mobile?\n                   \" about Wut\"))]\n              [:span.or \" or \"]\n              [:button.mlb-reset.login-bt\n                {:on-click #(user-actions/show-login :login-with-email)}\n                \"Login\"]])])\n      (when activity-data\n        [:div.activity-content-outer\n          [:div.activity-content\n            (when (:headline activity-data)\n              [:div.activity-title\n                {:dangerouslySetInnerHTML (utils/emojify (:headline activity-data))\n                 :class utils/hide-class}])\n            [:div.activity-content-author\n              (user-avatar-image (:publisher activity-data))\n              [:div.name\n                {:class utils/hide-class}\n                (str (:name (:publisher activity-data)) \" in \"\n                 (:board-name activity-data) \" on \")\n                 [:time\n                   {:date-time (:published-at activity-data)\n                    :data-toggle (when-not is-mobile? \"tooltip\")\n                    :data-placement \"top\"\n                    :data-container \"body\"\n                    :data-delay \"{\\\"show\\\":\\\"1000\\\", \\\"hide\\\":\\\"0\\\"}\"\n                    :data-title (utils/activity-date-tooltip activity-data)}\n                   (utils/date-string (utils/js-date (:published-at activity-data)) [:year])]]]\n            (when (:body activity-data)\n              [:div.activity-body.oc-mentions.oc-mentions-hover\n                {:dangerouslySetInnerHTML (utils/emojify (:body activity-data))\n                 :class utils/hide-class}])\n            (when (seq (:polls activity-data))\n              (polls-wrapper {:polls-data (:polls activity-data)\n                              :container-selector \"div.secure-activity-container\"}))\n            (stream-attachments (:attachments activity-data))\n            [:div.activity-content-footer.group\n              (comments-summary {:activity-data activity-data :comments-data comments-drv :current-activity-id (:uuid activity-data)})\n              (reactions {:entity-data activity-data})]\n            (when (or (pos? (count comments-data))\n                      (:can-comment activity-data))\n              [:div.comments-separator])\n            (when (:can-comment activity-data)\n              (rum/with-key (add-comment {:activity-data activity-data}) (str \"add-comment-\" (:uuid activity-data))))\n            (when comments-data\n              (stream-comments {:activity-data activity-data\n                                :comments-data comments-data\n                                :reply-add-comment-prefix \"secure-activity\"\n                                :current-user-id (:user-id id-token)}))]])\n      [:div.secure-activity-footer\n        (if id-token\n          [:button.mlb-reset.secure-activity-footer-bt\n            {:on-click #(user-actions/show-login :login-with-email)}\n            \"Log in required to access all posts\"]\n          [:a.sent-via-carrot\n            {:href oc-urls/home}\n            [:div.sent-via-carrot-copy\n              \"Sent with Wut\"]])]\n      (when-not activity-data\n        [:div.secure-activity-container\n          (loading {:loading true})])]))"]}